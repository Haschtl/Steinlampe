import { createContext, ReactNode, useContext, useEffect, useMemo, useState } from 'react';

type Lang = 'en' | 'de';

const translations: Record<Lang, Record<string, string>> = {
  en: {
    "nav.home": "Home",
    "nav.settings": "Settings",
    "nav.actions": "Actions",
    "nav.help": "Help",
    "nav.log": "Log",
    "nav.hardware": "Hardware",
    "btn.connect": "Connect",
    "btn.disconnect": "Disconnect",
    "btn.connectSerial": "Connect Serial",
    "btn.send": "Send",
    "toggle.autoReconnect": "Auto-reconnect",
    "title.app": "Quarzlampe",
    "title.lamp": "Lamp",
    "title.ramps": "Ramps",
    "title.notify": "Notify",
    "title.wake": "Wake",
    "title.sleep": "Sleep",
    "title.settings": "Settings",
    "title.log": "Log",
    "title.quick": "Quick Tap Modes",
    "title.custom": "Custom Pattern",
    "title.presence": "Presence",
    "title.touch": "Touch",
    "title.light": "Light",
    "title.music": "Music",
    "title.pattern": "Pattern",
    "title.ui": "UI Settings",
    "title.ledConfig": "Led configuration",
    "title.poti": "Potentiometer",
    "title.push": "Push Button",
    "title.morse": "Morse",
    "title.import": "Import / Export",
    "title.profiles": "Profiles",
    "title.help": "Command Reference & Links",
    "title.factory": "Factory Defaults",
    "title.factoryConfirm": "Reset all settings?",
    "label.language": "Language",
    "label.enabled": "Enabled",
    "label.profile": "Profile",
    "label.brightness": "Brightness",
    "label.speed": "Speed",
    "label.fade": "Fade",
    "label.fadeMul": "Pattern Fade",
    "label.sequence": "Sequence",
    "label.duration": "Duration",
    "label.mode": "Mode",
    "label.briPct": "Brightness (%)",
    "label.cap": "Brightness cap (%)",
    "label.alpha": "Smoothing",
    "label.gain": "Gain",
    "label.clamp": "Clamp",
    "label.idle": "Idle off (min)",
    "label.pwm": "PWM Curve",
    "label.rampOn": "Ramp On",
    "label.rampOff": "Ramp Off",
    "label.pow": "Power",
    "label.values": "Values (0..1 CSV)",
    "label.step": "Step",
    "label.repeat": "Repeat",
    "label.lightGain": "Light gain",
    "label.musicGain": "Music gain",
    "label.clapThr": "Clap thr",
    "label.threshold": "Threshold",
    "label.cool": "Cooldown",
    "label.smoothing": "Smoothing",
    "label.delta": "Delta",
    "label.offThresh": "Off threshold",
    "label.sampleMs": "Sample (ms)",
    "label.debounce": "Debounce",
    "label.double": "Double gap",
    "label.hold": "Hold",
    "label.stepMs": "Step interval",
    "label.stepPct": "Step (%)",
    "label.morseText": "Text",
    "label.theme": "Theme",
    "desc.patternSpeed": "Pattern speed multiplier",
    "desc.patternFade": "Smooth transitions between patterns",
    "desc.clamp": "Min/Max target brightness from ambient light",
    "desc.clap":
      "Threshold: envelope level to count a clap. Cooldown: minimum delay before a new clap window starts. Actions fire on 1/2/3 claps within the window.",
    "desc.musicSmooth": "Afterglow for direct mode: higher = softer/slower response.",
    "music.calibHint": "Start quiet, then clap once during calibration.",
    "desc.alpha": "Low-pass filter for sensor noise",
    "desc.brightness": "Set output level",
    "desc.tapSwitch":
      "Tap the physical switch to cycle through selected quick modes.",
    "desc.customStep": "Step duration for each custom value",
    "desc.language": "Toggle app language",
    "desc.potiAlpha": "Filter strength",
    "desc.potiDelta": "Minimum change before updating brightness",
    "desc.potiOff": "Below this the lamp will switch off",
    "desc.potiSample": "Interval for reading the knob",
    "desc.pushDebounce": "Ignore bounces shorter than this",
    "desc.pushDouble": "Maximum gap to detect a double press",
    "desc.pushHold": "Hold duration to start brightness ramp",
    "desc.pushStepMs": "Delay between brightness steps while held",
    "desc.pushStep": "Brightness increment per step",
    "desc.factory": "Reset all stored profiles and settings to defaults.",
    "desc.factoryConfirm": "This clears stored profiles and preferences.",
    "log.show": "Show",
    "log.hide": "Hide",
    "log.filter": "Filter status lines",
    "log.lines": "lines",
    "status.connected": "Connected",
    "status.disconnected": "Not connected",
    "status.last": "Last status",
    "music.autoLamp": "Auto Lamp",
    "music.clapActions": "Clap actions (send command on 1/2/3 claps)",
    "music.modeInfo":
      "Direct: brightness follows the level. Beat: peaks trigger short pulses with decay. Auto Lamp can turn on the lamp whenever the signal crosses the threshold (even if music is off).",
    "music.modeDirect":
      "Direct: brightness follows the level. Auto Lamp can additionally switch on with loud signal.",
    "music.modeBeat":
      "Beat: peaks trigger short flashes, decay holds until the next beat. Auto Lamp shares the threshold.",
    "label.clap": "Clap",
    "btn.load": "Load",
    "btn.save": "Save",
    "btn.sync": "Sync",
    "btn.on": "On",
    "btn.off": "Off",
    "btn.apply": "Apply",
    "btn.clear": "Clear",
    "btn.reload": "Reload",
    "btn.close": "Close",
    "btn.import": "Import",
    "btn.prev": "Prev",
    "btn.next": "Next",
    "btn.status": "Status",
    "btn.scan": "Scan",
    "btn.calibrate": "Calibrate",
    "btn.calibrateMin": "Calibrate min",
    "btn.calibrateMax": "Calibrate max",
    "desc.lightCalib":
      "Tip: First press “Calib min” while covering the sensor (dark), then “Calib max” under bright light so slow sensors get a clean span.",
    "btn.debug": "Debug",
    "btn.factory": "Factory reset",
    "btn.confirm": "Confirm",
    "btn.cancel": "Cancel",
    "btn.exportQr": "Export to text/QR",
    "btn.cfgExport": "cfg export",
    "btn.saveProfile": "Save Profile",
    "btn.loadProfile": "Load Profile",
    "btn.backup": "Backup Settings",
    "btn.saveQuick": "Save quick list",
    "btn.wake": "Wake",
    "btn.sleep": "Sleep",
    "btn.stop": "Stop",
    "label.soft": "Soft",
    "touch.onThr": "Touch on threshold",
    "touch.offThr": "Touch off threshold",
    "touch.calibTitle": "Touch calibration",
    "touch.baseline": "Baseline calibrate",
    "touch.baselineHint": "Touch the sensor, then press.",
    "touch.fullCalib": "Touch calibration",
    "touch.fullCalibHint": "Press without touching for 2s, then touch for 2s.",
    "touch.hold": "Touch hold duration",
    "touch.noDebug": "No debug data yet.",
    "touch.calibHint": "Choose a calibration mode.",
    "label.slot": "Slot",
    "notify.sosStart": "SOS Start",
    "notify.sosStop": "SOS Stop",
    "notify.preset.short": "Short blink",
    "notify.preset.soft": "Soft alert",
    "notify.preset.triple": "Triple pulse",
    "notify.preset.door": "Doorbell",
    "notify.preset.longfade": "Long fade alert",
    "notify.preset.double": "Double 60",
    "notify.preset.sos": "SOS",
    "search.pattern": "Search pattern",
    "help.bleGuids": "BLE GUIDs",
    "help.bleMidiOptional": "BLE-MIDI (optional)",
    "help.receiveOnly": "Receive-only",
    "help.midiMap": "MIDI Mapping (info, not a command)",
    "help.serviceUuid": "Service UUID",
    "help.charUuid": "Characteristic UUID",
    "help.bleMidiNote":
      "Standard BLE-MIDI UUIDs; enable with the optional BLE-MIDI flag. Write/WriteNR RX-only.",
    "help.commandsLinks": "Command Reference & Links",
  },
  de: {
    "nav.home": "Start",
    "nav.settings": "Einstellungen",
    "nav.actions": "Funktionen",
    "nav.help": "Hilfe",
    "nav.log": "Log",
    "nav.hardware": "Hardware",
    "btn.connect": "Verbinden",
    "btn.disconnect": "Trennen",
    "btn.connectSerial": "Seriell verbinden",
    "btn.send": "Senden",
    "toggle.autoReconnect": "Auto-Reconnect",
    "title.app": "Quarzlampe",
    "title.lamp": "Lampe",
    "title.ramps": "Rampen",
    "title.notify": "Benachrichtigung",
    "title.wake": "Wecken",
    "title.sleep": "Schlafen",
    "title.settings": "Einstellungen",
    "title.log": "Protokoll",
    "title.quick": "Schnell-Modi",
    "title.custom": "Custom-Muster",
    "title.presence": "Anwesenheit",
    "title.touch": "Touch",
    "title.light": "Licht",
    "title.music": "Musik",
    "title.pattern": "Pattern",
    "title.ui": "UI-Einstellungen",
    "title.ledConfig": "Led Konfiguration",
    "title.poti": "Poti",
    "title.push": "Taster",
    "title.morse": "Morse",
    "title.import": "Import / Export",
    "title.profiles": "Profile",
    "title.help": "Befehle & Links",
    "title.factory": "Werkseinstellungen",
    "title.factoryConfirm": "Alle Einstellungen zurücksetzen?",
    "label.language": "Sprache",
    "label.enabled": "Aktiv",
    "label.profile": "Profil",
    "label.brightness": "Helligkeit",
    "label.speed": "Geschwindigkeit",
    "label.fade": "Fade",
    "label.fadeMul": "Pattern Fade",
    "label.sequence": "Sequenz",
    "label.duration": "Dauer",
    "label.mode": "Modus",
    "label.briPct": "Helligkeit (%)",
    "label.cap": "Max. Helligkeit (%)",
    "label.alpha": "Glättung",
    "label.gain": "Verstärkung",
    "label.clamp": "Begrenzung",
    "label.idle": "Idle aus (Min)",
    "label.pwm": "PWM Kurve",
    "label.rampOn": "Rampe An",
    "label.rampOff": "Rampe Aus",
    "label.pow": "Power",
    "label.values": "Werte (0..1 CSV)",
    "label.step": "Schritt",
    "label.repeat": "Wiederholen",
    "label.lightGain": "Licht-Gain",
    "label.musicGain": "Musik-Gain",
    "label.clapThr": "Klatsch-Schwelle",
    "label.threshold": "Schwelle",
    "label.cool": "Cooldown",
    "label.smoothing": "Glättung",
    "label.delta": "Delta",
    "label.offThresh": "Ausschalt-Schwelle",
    "label.sampleMs": "Sample (ms)",
    "label.debounce": "Entprellen",
    "label.double": "Doppelklick-Fenster",
    "label.hold": "Hold",
    "label.stepMs": "Schrittintervall",
    "label.stepPct": "Schritt (%)",
    "label.morseText": "Text",
    "label.theme": "Theme",
    "desc.patternSpeed": "Geschwindigkeits-Multiplikator",
    "desc.patternFade": "Weiche Übergänge zwischen Mustern",
    "desc.clamp": "Min/Max Zielhelligkeit aus Umgebungslicht",
    "desc.clap":
      "Schwelle: Envelope-Level für einen Klatscher. Cooldown: Mindestabstand, bevor ein neues Klatsch-Fenster startet. Aktionen feuern bei 1/2/3 Klatschern im Fenster.",
    "desc.musicSmooth": "Nachglühen im Direkt-Modus: höher = weicher/langsamer.",
    "music.calibHint": "Erst leise bleiben, dann einmal klatschen während der Kalibrierung.",
    "desc.alpha": "Tiefpass gegen Sensorausreißer",
    "desc.brightness": "Ausgangspegel einstellen",
    "desc.tapSwitch":
      "Mit dem physischen Schalter durch die Quick-Modes blättern.",
    "desc.customStep": "Schrittdauer je Custom-Wert",
    "desc.language": "App-Sprache umschalten",
    "desc.potiAlpha": "Filter-Stärke",
    "desc.potiDelta": "Minimale Änderung vor neuer Ausgabe",
    "desc.potiOff": "Darunter schaltet die Lampe ab",
    "desc.potiSample": "Abtast-Intervall des Potis",
    "desc.pushDebounce": "Ignoriert kürzere Preller",
    "desc.pushDouble": "Maximale Lücke für Doppel-Tap",
    "desc.pushHold": "Hold-Dauer bis Dimmen startet",
    "desc.pushStepMs": "Verzögerung zwischen Helligkeits-Schritten",
    "desc.pushStep": "Helligkeits-Schrittweite",
    "desc.factory": "Setzt alle gespeicherten Profile und Einstellungen zurück.",
    "desc.factoryConfirm": "Dies löscht gespeicherte Profile und Präferenzen.",
    "log.show": "Anzeigen",
    "log.hide": "Verbergen",
    "log.filter": "Statuszeilen filtern",
    "log.lines": "Zeilen",
    "status.connected": "Verbunden",
    "status.disconnected": "Nicht verbunden",
    "status.last": "Letzter Status",
    "music.autoLamp": "Auto-Lampe",
    "music.clapActions": "Klatsch-Aktionen (1/2/3 Klatscher senden Befehl)",
    "music.modeInfo":
      "Direkt: Helligkeit folgt dem Pegel. Beat: Peaks triggern kurze Lichtstöße mit Decay. Auto-Lampe kann auch ohne Musik die Lampe einschalten, wenn die Schwelle überschritten wird.",
    "music.modeDirect":
      "Direkt: Helligkeit folgt dem Pegel. Auto-Lampe kann bei lautem Signal zusätzlich einschalten.",
    "music.modeBeat":
      "Beat: Peaks triggern kurze Lichtstöße, Decay hält bis zum nächsten Beat. Auto-Lampe nutzt dieselbe Schwelle.",
    "label.clap": "Klatschen",
    "btn.load": "Laden",
    "btn.save": "Speichern",
    "btn.sync": "Sync",
    "btn.on": "An",
    "btn.off": "Aus",
    "btn.apply": "Anwenden",
    "btn.clear": "Leeren",
    "btn.reload": "Neu laden",
    "btn.close": "Schließen",
    "btn.import": "Import",
    "btn.prev": "Zurück",
    "btn.next": "Weiter",
    "btn.status": "Status",
    "btn.scan": "Scannen",
    "btn.calibrate": "Kalibrieren",
    "btn.calibrateMin": "Min kalibrieren",
    "btn.calibrateMax": "Max kalibrieren",
    "desc.lightCalib":
      "Tipp: Erst „Min kalibrieren“ mit abgedecktem Sensor, dann „Max kalibrieren“ bei viel Licht drücken, damit träge Sensoren einen sauberen Bereich bekommen.",
    "btn.debug": "Debug",
    "btn.factory": "Factory Reset",
    "btn.confirm": "Bestätigen",
    "btn.cancel": "Abbrechen",
    "btn.exportQr": "Als Text/QR exportieren",
    "btn.cfgExport": "cfg export",
    "btn.saveProfile": "Profil speichern",
    "btn.loadProfile": "Profil laden",
    "btn.backup": "Profil exportieren",
    "btn.saveQuick": "Schnellliste speichern",
    "btn.wake": "Wecken",
    "btn.sleep": "Schlafen",
    "btn.stop": "Stop",
    "label.soft": "Sanft",
    "touch.onThr": "Touch Ein-Schwelle",
    "touch.offThr": "Touch Aus-Schwelle",
    "touch.calibTitle": "Touch-Kalibrierung",
    "touch.baseline": "Baseline kalibrieren",
    "touch.baselineHint": "Sensor berühren, dann drücken.",
    "touch.fullCalib": "Touch-Kalibrierung",
    "touch.fullCalibHint": "Drücken ohne berühren (2s), dann 2s berühren.",
    "touch.hold": "Touch-Haltedauer",
    "touch.noDebug": "Noch keine Debug-Daten.",
    "touch.calibHint": "Wähle eine Kalibrierungsart.",
    "label.slot": "Slot",
    "notify.sosStart": "SOS Start",
    "notify.sosStop": "SOS Stopp",
    "notify.preset.short": "Kurzer Blink",
    "notify.preset.soft": "Sanfter Alarm",
    "notify.preset.triple": "Dreifach-Puls",
    "notify.preset.door": "Türklingel",
    "notify.preset.longfade": "Langer Fade-Alarm",
    "notify.preset.double": "Doppel 60",
    "notify.preset.sos": "SOS",
    "search.pattern": "Muster suchen",
    "help.bleGuids": "BLE-GUIDs",
    "help.bleMidiOptional": "BLE-MIDI (optional)",
    "help.receiveOnly": "Nur Empfang",
    "help.midiMap": "MIDI Mapping (Info, kein Befehl)",
    "help.serviceUuid": "Service-UUID",
    "help.charUuid": "Char-UUID",
    "help.bleMidiNote":
      "Standard BLE-MIDI UUIDs; per optionalem Flag aktivieren. Write/WriteNR, nur RX.",
    "help.commandsLinks": "Befehle",
  },
};

const I18nContext = createContext<{ lang: Lang; setLang: (l: Lang) => void; t: (key: string, fallback?: string) => string }>({
  lang: 'en',
  setLang: () => undefined,
  t: (k, fb) => fb ?? k,
});

export function I18nProvider({ children }: { children: ReactNode }) {
  const [lang, setLang] = useState<Lang>('en');

  useEffect(() => {
    if (typeof navigator === 'undefined') return;
    const preferred = navigator.language || navigator.languages?.[0];
    if (preferred?.toLowerCase().startsWith('de')) setLang('de');
  }, []);

  const t = useMemo(
    () => (key: string, fallback?: string) => translations[lang][key] || translations.en[key] || fallback || key,
    [lang],
  );
  return <I18nContext.Provider value={{ lang, setLang, t }}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  return useContext(I18nContext);
}

export function Trans({ k, children }: { k: string; children?: ReactNode }) {
  const { t } = useI18n();
  return <>{t(k) || children}</>;
}
